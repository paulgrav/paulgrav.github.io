<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Using Cloudflare Access to secure access to service on your home network | Paul Grave</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><script type=text/javascript src=/js/trace.4572df7a583fc5efb65969327c8cf1bc9d35c29acf8b35369588eae12dec1d141c4a337bd0a6c79e425da639c8116b2b519543d086b518b71291f3801f28ef19.js integrity="sha512-RXLfelg/xe+2WWkyfIzxvJ01wprPizU2lYjq4S3sHRQcSjN70KbHnkJdpjnIEWsrUZVD0Ia1GLcSkfOAHyjvGQ=="></script><meta property="og:title" content="Using Cloudflare Access to secure access to service on your home network"><meta property="og:description" content="Using Cloudflare Access to secure access to services on your home network The problem I’ve always wanted to run services on my local network and access them remotely but until now setting up authorization and encryption has been a minefield. Certificates would cost money, and the setup was a pain. Authorization would need to be configured on an per-app basis. Apps may have built-in auth, or they may leave that problem to the user."><meta property="og:type" content="article"><meta property="og:url" content="https://paulgrav.github.io/posts/cloudflareaccess/"><meta property="article:published_time" content="2020-11-08T09:40:11+00:00"><meta property="article:modified_time" content="2020-11-08T09:40:11+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Cloudflare Access to secure access to service on your home network"><meta name=twitter:description content="Using Cloudflare Access to secure access to services on your home network The problem I’ve always wanted to run services on my local network and access them remotely but until now setting up authorization and encryption has been a minefield. Certificates would cost money, and the setup was a pain. Authorization would need to be configured on an per-app basis. Apps may have built-in auth, or they may leave that problem to the user."><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2><link rel=preload href=/lib/JetBrainsMono/ttf/JetBrainsMono-Regular.ttf as=font type=font/ttf><link rel=stylesheet href=https://paulgrav.github.io/css/style-dark.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://paulgrav.github.io/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a><a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a><a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast');" style=display:none><i class="fas fa-chevron-up fa-lg"></i></a><span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://paulgrav.github.io/posts/doorbell/><i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li><li><a class=icon href=#><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f"><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&text=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&title=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&is_video=false&description=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network&body=Check out this article: https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f"><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&title=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&title=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&title=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-stumbleupon" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&title=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-digg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&name=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network&description=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20services%20on%20your%20home%20network%20The%20problem%20I%e2%80%99ve%20always%20wanted%20to%20run%20services%20on%20my%20local%20network%20and%20access%20them%20remotely%20but%20until%20now%20setting%20up%20authorization%20and%20encryption%20has%20been%20a%20minefield.%20Certificates%20would%20cost%20money%2c%20and%20the%20setup%20was%20a%20pain.%20Authorization%20would%20need%20to%20be%20configured%20on%20an%20per-app%20basis.%20Apps%20may%20have%20built-in%20auth%2c%20or%20they%20may%20leave%20that%20problem%20to%20the%20user."><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&t=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#the-problem>The problem</a></li><li><a href=#describe-the-flow>Describe the flow</a></li><li><a href=#step-1-setup-cloudflare>Step 1. Setup Cloudflare</a></li><li><a href=#step-2-configure-ssl>Step 2. Configure SSL</a></li><li><a href=#step-3-configure-cloudflare-access>Step 3. Configure Cloudflare Access</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Using Cloudflare Access to secure access to service on your home network</h1><div class=meta><div class=postdate><time datetime="2020-11-08 09:40:11 +0000 UTC" itemprop=datePublished>2020-11-08</time></div><div class=article-tag><i class="fas fa-tag"></i><a class=tag-link href=/tags/security rel=tag>security</a></div></div></header><div class=content itemprop=articleBody><h1 id=using-cloudflare-access-to-secure-access-to-services-on-your-home-network>Using Cloudflare Access to secure access to services on your home network</h1><h2 id=the-problem>The problem</h2><p>I’ve always wanted to run services on my local network and access them remotely but until now setting up authorization and encryption has been a minefield. Certificates would cost money, and the setup was a pain. Authorization would need to be configured on an per-app basis. Apps may have built-in auth, or they may leave that problem to the user. Thusfar I avoided exposing any services to the public internet.</p><p>This article describes how you can setup authorization and encryption for your services running on your home network.</p><p>You’re going to need a Cloudflare account. Cloudflare is developer friendly CDN provider but has a lot of other interesting features. It will setup and manage the encryption and authorization.</p><p>A Github account is required. We’ll using Github as our Identity Provider. You can use other IdPs but I’m guessing that there’s a good chance you have a Github account if you’re reading this.</p><p>Lastly, you’ll need Docker installed. We’re going to use Nginx as our pretend service.</p><p>There are a couple of assumptions:</p><ul><li>Port forwarding is configured on your router.</li><li>You know the public IP that your ISP assigns to you. I’m not going to describe how you setup dynamic DNS, there is plethora for blogs that explain that.</li><li>You must have domain name, and are able create and configure domain records. Again, I’m assuming you know how to do this.</li></ul><h2 id=describe-the-flow>Describe the flow</h2><p>Cloudflare is going to sit between the user and the services running on your home network. It ensure that users are authenticated with the GitHub</p><p><img src=/images/cloudflareflow.png alt="Example image"></p><p>User makes a request for a service.</p><p>User—->CF Access—->IdP—->Traefik</p><h2 id=step-1-setup-cloudflare>Step 1. Setup Cloudflare</h2><p>Sign-up for Cloudflare.</p><p>Create a zone (example.com)</p><p>Create a couple of host records (nginx.origin.example.com, nginx.example.com)</p><h2 id=step-2-configure-ssl>Step 2. Configure SSL</h2><p>Explain how Cloudflare will provision its own certs for your domain.</p><p>Explain the you need to encrypt traffic between CF and your origin.</p><p>Explain why you want your origin to validate from where requests originate.</p><ul><li>Configure Authenticated Origin Pull Force your origin web server to validate that a web request comes from Cloudflare.</li></ul><ol><li>Full Strict</li><li>Origin Server. Create Certificate</li><li>Download cert details.</li><li>Run Docker.</li></ol><p>Bonus point</p><p>Install Origin Pull</p><h2 id=step-3-configure-cloudflare-access>Step 3. Configure Cloudflare Access</h2><ol><li>Setup One-Time Pin</li><li>Select Github and follow instructions</li><li>Configure any other IdPs that you’d like</li><li>Create an access policy
5. App name: nginx
6. Sub domain: nginx
7. Leave session duration
8. Policy name: github (can be anything)
9. Include: emails and enter your Github email address
10. Save</li><li>Now visit nginx.example.com</li></ol></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#the-problem>The problem</a></li><li><a href=#describe-the-flow>Describe the flow</a></li><li><a href=#step-1-setup-cloudflare>Step 1. Setup Cloudflare</a></li><li><a href=#step-2-configure-ssl>Step 2. Configure SSL</a></li><li><a href=#step-3-configure-cloudflare-access>Step 3. Configure Cloudflare Access</a></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f"><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&text=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&title=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&is_video=false&description=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network&body=Check out this article: https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f"><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&title=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&title=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&title=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-stumbleupon fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&title=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-digg fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&name=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network&description=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20services%20on%20your%20home%20network%20The%20problem%20I%e2%80%99ve%20always%20wanted%20to%20run%20services%20on%20my%20local%20network%20and%20access%20them%20remotely%20but%20until%20now%20setting%20up%20authorization%20and%20encryption%20has%20been%20a%20minefield.%20Certificates%20would%20cost%20money%2c%20and%20the%20setup%20was%20a%20pain.%20Authorization%20would%20need%20to%20be%20configured%20on%20an%20per-app%20basis.%20Apps%20may%20have%20built-in%20auth%2c%20or%20they%20may%20leave%20that%20problem%20to%20the%20user."><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpaulgrav.github.io%2fposts%2fcloudflareaccess%2f&t=Using%20Cloudflare%20Access%20to%20secure%20access%20to%20service%20on%20your%20home%20network"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu class=icon href=# onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden=true></i>Menu</a>
<a id=toc class=icon href=# onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden=true></i>TOC</a>
<a id=share class=icon href=# onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden=true></i>share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i>Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2021 Paul Grave</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>